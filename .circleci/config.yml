version: 2.1

commands:
  install-dependencies:
    steps:
      - run:
          name: "Install latest commit of loanpy from git"
          command: pip install git+https://github.com/martino-vic/loanpy.git@2.0.1
      - run:    
          name: "Install pytest"
          command: pip install pytest
      - run:
          name: "Run unit and integration tests"
          command: python -m pytest

jobs:
  build-linux:
    parameters:
      python_version:
        type: string
    docker:
      - image: python:<< parameters.python_version >>
    steps:
      - checkout
      - install-dependencies

  build-windows:
    parameters:
      python_version:
        type: string
    machine:
      image: windows-default
    environment:
      DOCKER_PYTHON_VERSION: << parameters.python_version >>
    steps:
      - checkout
      - run:
          name: "Pull Python Docker image"
          command: docker pull python:$env:DOCKER_PYTHON_VERSION-windowsservercore
      - run:
          name: "Run tests in Docker container"
          command: |
            docker run --rm -v "$(pwd):C:/project" -w "C:/project" python:$env:DOCKER_PYTHON_VERSION-windowsservercore powershell -Command "pip install --upgrade pip; .\install-dependencies"

workflows:
  version: 2
  build-and-test:
    jobs:
      - build-linux:
          matrix:
            parameters:
              python_version: ["3.7", "3.8", "3.9", "3.10", "3.11"]
      - build-windows:
          matrix:
            parameters:
              python_version: ["3.7", "3.8", "3.9", "3.10", "3.11"]
